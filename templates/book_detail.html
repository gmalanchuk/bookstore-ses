<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.title }} - BookStore</title>
    <link rel="stylesheet" href="/static/book_detail.css">
</head>
<body>
    {% include 'include/navbar.html' %}

    <main class="book-details-page">
        <div class="bd-container">
            <div class="bd-card">
                <div class="bd-grid">
                    <div class="bd-cover-column">
                        <img src="{{ book.cover_path or 'https://via.placeholder.com/300x450?text=No+Cover' }}"
                             alt="{{ book.title }}" class="bd-image">
                    </div>

                    <div class="bd-info-column">
                        <h1 class="bd-title">{{ book.title }}</h1>

                        <div class="bd-meta-list">
                            <div class="bd-meta-row">
                                <span class="bd-label">Автор:</span>
                                <span class="bd-value">
                                    <a href="/authors/{{ book.author_id }}" class="author-link">{{ book.author_name }}</a>
                                </span>
                            </div>
                            <div class="bd-meta-row">
                                <span class="bd-label">Жанр:</span>
                                <span class="bd-value">{{ book.genre_name }}</span>
                            </div>
                            <div class="bd-meta-row">
                                <span class="bd-label">Видавництво:</span>
                                <span class="bd-value">{{ book.publisher_name }}</span>
                            </div>
                            <div class="bd-meta-row">
                                <span class="bd-label">Рік видання:</span>
                                <span class="bd-value">{{ book.publication_year }}</span>
                            </div>
                        </div>

                        <div class="bd-description">
                            <h2 class="bd-section-title">Опис</h2>
                            <p class="bd-text">
                                {{ book.description }}
                            </p>
                        </div>

                        <div class="bd-action-bar">
                            <div class="bd-price">{{ "%.2f"|format(book.price) }} грн</div>
                            <div class="bd-stock">
                                В наявності:
                                <span class="bd-stock-count">
                                    {% if book.stock_quantity > 0 %}
                                        {{ book.stock_quantity }} шт.
                                    {% else %}
                                        Немає в наявності
                                    {% endif %}
                                </span>
                            </div>

                            {% if book.stock_quantity > 0 %}
                                <form method="post" action="/cart/add/{{ book.id }}" style="display: inline;">
                                    <button type="submit" class="bd-add-btn">Додати до кошика</button>
                                </form>
                            {% else %}
                                <button class="bd-add-btn" disabled style="background: gray;">Очікується</button>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция отзывов -->
            <div class="bd-reviews-section">
                <h2 class="bd-reviews-title">Відгуки</h2>

                <!-- Форма добавления отзыва -->
                {% if user_id %}
                    {% if not user_has_review %}
                    <div class="bd-review-form-card">
                        <h3 class="bd-form-title">Залишити відгук</h3>
                        <form method="post" action="/books/{{ book.id }}/review" class="bd-review-form">
                            <div class="bd-rating-select">
                                <label class="bd-form-label">Оцінка:</label>
                                <div class="bd-stars-input">
                                    {% for i in range(5, 0, -1) %}
                                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                                    <label for="star{{ i }}" class="bd-star-label">★</label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="bd-comment-input">
                                <label for="comment_text" class="bd-form-label">Коментар:</label>
                                <textarea id="comment_text" name="comment_text" rows="4"
                                          placeholder="Напишіть ваш відгук про книгу..." class="bd-textarea"></textarea>
                            </div>
                            <button type="submit" class="bd-submit-review-btn">Відправити відгук</button>
                        </form>
                    </div>
                    {% else %}
                    <div class="bd-review-notice">
                        <p>Ви вже залишили відгук на цю книгу.</p>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="bd-review-notice">
                        <p>Щоб залишити відгук, будь ласка, <a href="/login" class="author-link">увійдіть</a> в систему.</p>
                    </div>
                {% endif %}

                <!-- Список отзывов -->
                <div class="bd-reviews-list">
                    {% if reviews %}
                        {% for review in reviews %}
                        <div class="bd-review-card">
                            <div class="bd-review-header">
                                <span class="bd-reviewer-name">{{ review.user_name }}</span>
                                <span class="bd-review-rating">
                                    {% for i in range(review.rating) %}★{% endfor %}{% for i in range(5 - review.rating) %}☆{% endfor %}
                                </span>
                            </div>
                            {% if review.comment_text %}
                            <p class="bd-review-text">{{ review.comment_text }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="bd-no-reviews">Поки що немає відгуків. Будьте першим!</p>
                    {% endif %}
                </div>
            </div>

            <a href="/books" class="back-link">← Повернутися до каталогу</a>
        </div>
    </main>
</body>
</html>
