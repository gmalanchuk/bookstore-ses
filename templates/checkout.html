<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</title>
    <link rel="stylesheet" href="/static/checkout.css">
</head>
<body>
    {% include 'include/navbar.html' %}

    <div class="checkout-page">
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

        <div class="checkout-container">
            <!-- –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è -->
            <div class="checkout-form-section">
                <h2>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h2>
                <form method="post" action="/order/confirm" class="checkout-form" id="checkout-form">
                    <div class="form-group">
                        <label for="full_name">–ü–æ–≤–Ω–µ —ñ–º'—è</label>
                        <input type="text" id="full_name" name="full_name"
                               value="{{ user.full_name }}" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email"
                               value="{{ user.email }}" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="phone" name="phone"
                               placeholder="+380XXXXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label for="address">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <textarea id="address" name="address" rows="3"
                                  placeholder="–ú—ñ—Å—Ç–æ, –≤—É–ª–∏—Ü—è, –±—É–¥–∏–Ω–æ–∫, –∫–≤–∞—Ä—Ç–∏—Ä–∞" required></textarea>
                    </div>

                    <h2>–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏</h2>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="payment_method" value="card" id="payment-card" checked>
                            <span class="payment-label">üí≥ –ë–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –∫–∞—Ä—Ç–∫–∞</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment_method" value="cash" id="payment-cash">
                            <span class="payment-label">üíµ –ì–æ—Ç—ñ–≤–∫–æ—é –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ</span>
                        </label>
                    </div>

                    <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ –ø–æ–ª—è –¥–ª—è –¥–∞–Ω–∏—Ö –∫–∞—Ä—Ç–∫–∏ -->
                    <input type="hidden" name="card_number" id="card_number_hidden">
                    <input type="hidden" name="card_expiry" id="card_expiry_hidden">
                    <input type="hidden" name="card_cvv" id="card_cvv_hidden">

                    <button type="submit" class="confirm-btn">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
                </form>
            </div>

            <!-- –ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
            <div class="order-summary">
                <h2>–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>

                <div class="summary-items">
                    {% for item in cart_items %}
                        <div class="summary-item">
                            <img src="{{ item.cover_path }}" alt="{{ item.title }}">
                            <div class="summary-item-info">
                                <h4>{{ item.title }}</h4>
                                <p>{{ item.author_name }}</p>
                                <p class="item-qty">–ö—ñ–ª—å–∫—ñ—Å—Ç—å: {{ item.quantity }}</p>
                            </div>
                            <div class="summary-item-price">
                                {{ item.total_price }} –≥—Ä–Ω
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="summary-totals">
                    <div class="summary-row">
                        <span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–Ω–∏–≥:</span>
                        <span>{{ total_items }}</span>
                    </div>
                    <div class="summary-row total">
                        <span>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</span>
                        <span>{{ total_cost }} –≥—Ä–Ω</span>
                    </div>
                </div>

                <a href="/cart" class="back-link">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–æ—à–∏–∫–∞</a>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–∞—Ä—Ç–∫–∏ -->
    <div class="modal-overlay" id="card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ –í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –∫–∞—Ä—Ç–∫–∏</h2>
                <button type="button" class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="card_number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏</label>
                    <input type="text" id="card_number" placeholder="1234 5678 9012 3456"
                           maxlength="19" autocomplete="cc-number">
                </div>
                <div class="card-row">
                    <div class="form-group">
                        <label for="card_expiry">–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó</label>
                        <input type="text" id="card_expiry" placeholder="MM/YY"
                               maxlength="5" autocomplete="cc-exp">
                    </div>
                    <div class="form-group">
                        <label for="card_cvv">CVV</label>
                        <input type="text" id="card_cvv" placeholder="123"
                               maxlength="3" autocomplete="cc-csc">
                    </div>
                </div>
                <div class="form-group">
                    <label for="card_holder">–Ü–º'—è –≤–ª–∞—Å–Ω–∏–∫–∞ –∫–∞—Ä—Ç–∫–∏</label>
                    <input type="text" id="card_holder" placeholder="IVAN PETRENKO"
                           autocomplete="cc-name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" id="btn-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn-pay" id="btn-pay">–û–ø–ª–∞—Ç–∏—Ç–∏ {{ total_cost }} –≥—Ä–Ω</button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('checkout-form');
        const modal = document.getElementById('card-modal');
        const modalClose = document.getElementById('modal-close');
        const btnCancel = document.getElementById('btn-cancel');
        const btnPay = document.getElementById('btn-pay');
        const paymentCard = document.getElementById('payment-card');
        const paymentCash = document.getElementById('payment-cash');

        // –ü–æ–ª—è –∫–∞—Ä—Ç–∫–∏
        const cardNumber = document.getElementById('card_number');
        const cardExpiry = document.getElementById('card_expiry');
        const cardCvv = document.getElementById('card_cvv');
        const cardHolder = document.getElementById('card_holder');

        // –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ –ø–æ–ª—è —Ñ–æ—Ä–º–∏
        const cardNumberHidden = document.getElementById('card_number_hidden');
        const cardExpiryHidden = document.getElementById('card_expiry_hidden');
        const cardCvvHidden = document.getElementById('card_cvv_hidden');

        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç–∫–∏
        cardNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value.substring(0, 19);
        });

        // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó
        cardExpiry.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            e.target.value = value.substring(0, 5);
        });

        // –¢—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏ –¥–ª—è CVV
        cardCvv.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
        });

        // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∏
        form.addEventListener('submit', function(e) {
            if (paymentCard.checked) {
                e.preventDefault();
                openModal();
            }
        });

        function openModal() {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            cardNumber.focus();
        }

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        modalClose.addEventListener('click', closeModal);
        btnCancel.addEventListener('click', closeModal);

        // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ –∫–ª—ñ–∫—É –Ω–∞ overlay
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });

        // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                closeModal();
            }
        });

        // –û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–∫–æ—é
        btnPay.addEventListener('click', function() {
            // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
            const cardNum = cardNumber.value.replace(/\s/g, '');
            const expiry = cardExpiry.value;
            const cvv = cardCvv.value;
            const holder = cardHolder.value.trim();

            if (cardNum.length < 16) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏');
                cardNumber.focus();
                return;
            }
            if (expiry.length < 5) {
                alert('–í–≤–µ–¥—ñ—Ç—å —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó –∫–∞—Ä—Ç–∫–∏');
                cardExpiry.focus();
                return;
            }
            if (cvv.length < 3) {
                alert('–í–≤–µ–¥—ñ—Ç—å CVV –∫–æ–¥');
                cardCvv.focus();
                return;
            }
            if (!holder) {
                alert("–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –≤–ª–∞—Å–Ω–∏–∫–∞ –∫–∞—Ä—Ç–∫–∏");
                cardHolder.focus();
                return;
            }

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –≤ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –ø–æ–ª—è (–æ—Å—Ç–∞–Ω–Ω—ñ 4 —Ü–∏—Ñ—Ä–∏ –¥–ª—è –±–µ–∑–ø–µ–∫–∏)
            cardNumberHidden.value = '**** **** **** ' + cardNum.slice(-4);
            cardExpiryHidden.value = expiry;
            cardCvvHidden.value = '***';

            closeModal();
            form.submit();
        });
    </script>
</body>
</html>
